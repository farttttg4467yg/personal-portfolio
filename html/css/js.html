<!--
Faraday – Multi‑User Chat with File Sharing (HTML/CSS/JS + Firebase)
Files in this project:
1) index.html  (this file)
2) style.css
3) app.js
4) firebaseConfig.js (fill your Firebase keys)

Quick start:
- Create a Firebase project (Console > Add Project)
- Enable Authentication > Sign-in method > Anonymous (ON)
- Enable Firestore Database (Start in production or test)
- Enable Storage (default bucket)
- In Project settings > General > Your apps (Web) > get config, paste into firebaseConfig.js
- Optional: Set Storage rules to allow authenticated users to read/write.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faraday – Interactive Chat</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Animated background with floating math glyphs -->
  <div class="bg">
    <ul class="glyphs">
      <li>∫</li><li>Σ</li><li>π</li><li>E=mc²</li><li>Δ</li><li>λ</li><li>Ω</li><li>∂</li>
    </ul>
    <canvas id="sparkCanvas" aria-hidden="true"></canvas>
  </div>

  <main class="wrap">
    <header class="topbar">
      <div class="brand">
        <div class="logo">⚡</div>
        <div class="titles">
          <h1>Faraday</h1>
          <p class="subtitle">Realtime chat • file sharing</p>
        </div>
      </div>
      <div class="userbox">
        <span class="statusDot" id="statusDot"></span>
        <span id="whoami">Connecting…</span>
      </div>
    </header>

    <section class="chat">
      <aside class="side">
        <div class="card">
          <h3>Room</h3>
          <div class="roomBox">
            <input id="roomInput" type="text" placeholder="room name (e.g., physics)" />
            <button id="joinBtn" title="Join room">Join</button>
          </div>
          <p class="hint">Tip: share the same room name with friends to chat together.</p>
        </div>

        <div class="card">
          <h3>Users online</h3>
          <ul id="userList" class="userList"></ul>
        </div>
      </aside>

      <section class="pane">
        <ul id="messages" class="messages" aria-live="polite"></ul>

        <form id="composer" class="composer" autocomplete="off">
          <input id="nameInput" class="nameInput" type="text" placeholder="your nickname" />
          <input id="msgInput" class="msgInput" type="text" placeholder="Type a message…" />
          <input id="fileInput" class="fileInput" type="file" title="Share a file" />
          <button id="sendBtn" type="submit" class="sendBtn" title="Send">Send</button>
        </form>
      </section>
    </section>
  </main>

  <!-- Old scientist cartoon character (SVG) -->
  <div class="scientist" title="Professor Faraday">
    <svg viewBox="0 0 240 260" width="240" height="260" aria-hidden="true">
      <!-- simple stylized character -->
      <defs>
        <clipPath id="headClip"><circle cx="120" cy="90" r="55"/></clipPath>
      </defs>
      <!-- coat -->
      <path d="M60 170 Q120 130 180 170 L170 250 H70 Z" fill="#e6eef7" stroke="#94a3b8" stroke-width="3"/>
      <!-- arms -->
      <path d="M60 170 Q40 180 35 210" stroke="#94a3b8" stroke-width="6" fill="none"/>
      <path class="wave" d="M180 170 Q200 180 205 205" stroke="#94a3b8" stroke-width="6" fill="none"/>
      <!-- head -->
      <circle cx="120" cy="90" r="55" fill="#f0d6b7" stroke="#a78b6d" stroke-width="3"/>
      <!-- hair -->
      <g clip-path="url(#headClip)">
        <circle cx="80" cy="60" r="22" fill="#ffffff"/>
        <circle cx="160" cy="60" r="22" fill="#ffffff"/>
        <ellipse cx="120" cy="40" rx="60" ry="25" fill="#ffffff"/>
      </g>
      <!-- glasses -->
      <circle cx="100" cy="95" r="14" fill="#fff" stroke="#475569" stroke-width="3"/>
      <circle cx="140" cy="95" r="14" fill="#fff" stroke="#475569" stroke-width="3"/>
      <line x1="114" y1="95" x2="126" y2="95" stroke="#475569" stroke-width="3"/>
      <!-- eyes -->
      <circle class="blink" cx="100" cy="95" r="4" fill="#0f172a"/>
      <circle class="blink" cx="140" cy="95" r="4" fill="#0f172a"/>
      <!-- mustache -->
      <path d="M95 112 Q120 125 145 112" stroke="#475569" stroke-width="5" fill="none"/>
      <!-- lightning badge -->
      <polygon points="118,185 130,170 126,190 137,190 120,210 125,195 113,195" fill="#facc15" stroke="#a16207" stroke-width="2"/>
    </svg>
    <div class="speech">Welcome to Faraday!</div>
  </div>

  <!-- App scripts -->
  <script type="module" src="firebaseConfig.js"></script>
  <script type="module" src="app.js"></script>
</body>
</html>

<!-- ============================= -->
<!-- 2) style.css                  -->
<!-- ============================= -->

<style id="__style_placeholder__">/* Move this content into style.css */
:root{--bg1:#0f172a;--bg2:#1e293b;--panel:#0b1220cc;--card:#0f172acc;--accent:#22d3ee;--accent-2:#a78bfa;--text:#e2e8f0;--muted:#94a3b8;--good:#22c55e;--warn:#f59e0b;}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;color:var(--text);background:radial-gradient(1200px 800px at 10% 10%,#0b1220 0%,#0f172a 35%,#020617 100%);overflow:hidden}

/* animated gradient sparks */
.bg{position:fixed;inset:0;overflow:hidden;z-index:-2}
.glyphs{position:absolute;inset:0;list-style:none;margin:0;padding:0;pointer-events:none}
.glyphs li{position:absolute;color:#ffffff18;font-weight:800;font-size:clamp(20px,6vw,70px);animation:float 14s linear infinite;left:var(--x,50%);top:var(--y,50%)}
.glyphs li:nth-child(odd){color:#22d3ee15}
@keyframes float{0%{transform:translate(-50%,110vh) rotate(0deg)}100%{transform:translate(-50%,-10vh) rotate(360deg)}}

#sparkCanvas{position:absolute;inset:0;opacity:.35;filter:blur(.2px)}

.wrap{position:relative;max-width:1100px;margin:24px auto;padding:16px;display:grid;gap:16px}
.topbar{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,#0b1220e6,#0b1220cc);backdrop-filter:blur(6px);border:1px solid #172032;border-radius:16px;padding:12px 16px;box-shadow:0 10px 30px #00000050}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:40px;height:40px;display:grid;place-items:center;border-radius:12px;background:conic-gradient(from 210deg at 50% 50%,var(--accent),var(--accent-2));box-shadow:0 6px 14px #00000080}
.titles h1{margin:0;font-size:20px;letter-spacing:.5px}
.subtitle{margin:0;color:var(--muted);font-size:12px}
.userbox{display:flex;align-items:center;gap:8px;color:var(--muted)}
.statusDot{width:10px;height:10px;background:var(--warn);border-radius:99px;box-shadow:0 0 0 4px #f59e0b20}

.chat{display:grid;grid-template-columns:280px 1fr;gap:16px;min-height:70vh}
.side{display:grid;gap:16px}
.card{background:linear-gradient(180deg,#0b1220cc,#0b1220b3);border:1px solid #172032;border-radius:16px;padding:14px}
.card h3{margin-top:0;margin-bottom:8px;font-size:14px;color:#cbd5e1}
.roomBox{display:flex;gap:8px}
.roomBox input{flex:1}
.hint{margin-top:8px;color:#8ea0b6;font-size:12px}
.userList{margin:8px 0 0;padding:0;list-style:none;display:grid;gap:6px;max-height:260px;overflow:auto}
.userList li{padding:6px 8px;border-radius:10px;background:#0f172a;display:flex;align-items:center;gap:8px;border:1px solid #162238}
.userBadge{width:8px;height:8px;border-radius:99px;background:#22d3ee}

.pane{position:relative;display:grid;grid-template-rows:1fr auto;background:linear-gradient(180deg,#0b1220cc,#0b1220b3);border:1px solid #172032;border-radius:16px;min-height:70vh}
.messages{list-style:none;margin:0;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:10px}
.msg{max-width:70%;padding:10px 12px;border-radius:14px;border:1px solid #162238;background:#0f172a;box-shadow:inset 0 1px 0 #ffffff06}
.msg.me{margin-left:auto;background:#0b5; border-color:#064;}
.meta{display:flex;justify-content:space-between;gap:8px;font-size:11px;color:#9fb0c6;margin-top:6px}
.name{font-weight:600;letter-spacing:.3px}
.body{white-space:pre-wrap;word-break:break-word}
.file{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:#0e1a2f;border:1px dashed #1f2b44;margin-top:6px}
.file img{max-height:140px;border-radius:10px}

.composer{display:grid;grid-template-columns:180px 1fr auto auto;gap:8px;padding:10px;border-top:1px solid #172032;background:#0b1220bb;border-radius:0 0 16px 16px}
.composer input[type="text"]{border:1px solid #203047;background:#0f172a;color:var(--text);padding:10px;border-radius:12px;outline:none}
.fileInput{display:block}
.sendBtn, .composer button, .roomBox button{background:linear-gradient(180deg,#06b6d4,#3b82f6);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 4px 18px #06b6d455}
.sendBtn:hover{filter:brightness(1.05)}

/* Scientist */
.scientist{position:fixed;right:12px;bottom:12px;transform:translateZ(0);user-select:none}
.scientist .speech{position:absolute;right:220px;bottom:210px;background:#0f172a;border:1px solid #172032;padding:8px 10px;border-radius:10px;box-shadow:0 6px 18px #00000070}
.wave{transform-origin:180px 170px;animation:wave 1.6s ease-in-out infinite}
@keyframes wave{0%,100%{transform:rotate(0deg)}50%{transform:rotate(8deg)}}
.blink{animation:blink 4s infinite}
@keyframes blink{0%,96%,100%{r:4px}97%{r:0.2px}}

/* Responsive */
@media (max-width: 900px){.chat{grid-template-columns:1fr}.side{order:2}.pane{order:1}}
</style>

<!-- ============================= -->
<!-- 3) app.js                     -->
<!-- ============================= -->
<script type="module" id="__app_placeholder__">/* Move this content into app.js */
import { app, auth, db, storage } from './firebaseConfig.js';
import { 
  getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, where,
  doc, setDoc, deleteDoc
} from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
import { 
  ref as sRef, uploadBytesResumable, getDownloadURL
} from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';
import { 
  onAuthStateChanged, signInAnonymously, updateProfile
} from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';

// DOM
const roomInput = document.getElementById('roomInput');
const joinBtn   = document.getElementById('joinBtn');
const userList  = document.getElementById('userList');
const messages  = document.getElementById('messages');
const nameInput = document.getElementById('nameInput');
const msgInput  = document.getElementById('msgInput');
const fileInput = document.getElementById('fileInput');
const composer  = document.getElementById('composer');
const whoami    = document.getElementById('whoami');
const statusDot = document.getElementById('statusDot');

let currentRoom = 'lobby';
let unsubMessages = null;
let unsubPresence = null;

function setStatus(color){ statusDot.style.background = color }

// Anonymous auth, then set default nickname
onAuthStateChanged(auth, async (user) => {
  if(!user){
    await signInAnonymously(auth);
    return;
  }
  whoami.textContent = `you: ${user.displayName || 'guest-' + user.uid.slice(0,6)}`;
  nameInput.value = user.displayName || '';
  setStatus('var(--good)');
  joinRoom(currentRoom);
});

nameInput.addEventListener('change', async () => {
  const user = auth.currentUser;
  if(!user) return;
  await updateProfile(user, { displayName: nameInput.value.slice(0,20) || null });
  whoami.textContent = `you: ${user.displayName || 'guest-' + user.uid.slice(0,6)}`;
});

joinBtn.addEventListener('click', () => {
  const r = (roomInput.value || 'lobby').trim().toLowerCase();
  joinRoom(r);
});

async function joinRoom(room){
  // detach listeners
  if(unsubMessages) unsubMessages();
  if(unsubPresence) unsubPresence();

  currentRoom = room;
  roomInput.value = room;
  messages.innerHTML = '';

  // presence: add this user to room's presence collection
  const meDoc = doc(db, 'rooms', room, 'presence', auth.currentUser.uid);
  await setDoc(meDoc, {
    name: auth.currentUser.displayName || ('guest-' + auth.currentUser.uid.slice(0,6)),
    at: serverTimestamp()
  }, { merge: true });

  // live presence list
  const presQ = query(collection(db, 'rooms', room, 'presence'));
  unsubPresence = onSnapshot(presQ, (snap) => {
    userList.innerHTML = '';
    snap.forEach(d => {
      const li = document.createElement('li');
      const dot = document.createElement('span'); dot.className = 'userBadge';
      li.appendChild(dot);
      li.appendChild(document.createTextNode(' ' + (d.data().name || 'guest')));
      userList.appendChild(li);
    });
  });

  // live messages
  const q = query(collection(db, 'rooms', room, 'messages'), orderBy('at'));
  unsubMessages = onSnapshot(q, (snap) => {
    snap.docChanges().forEach(change => {
      if(change.type === 'added'){
        renderMessage(change.doc.id, change.doc.data());
      } else if(change.type === 'removed'){
        const el = document.getElementById('m-' + change.doc.id);
        if(el) el.remove();
      }
    });
    // auto scroll
    messages.scrollTop = messages.scrollHeight;
  });
}

function renderMessage(id, data){
  const me = auth.currentUser?.uid;
  const isMe = data.uid === me;
  const li = document.createElement('li');
  li.className = 'msg' + (isMe ? ' me' : '');
  li.id = 'm-' + id;

  const body = document.createElement('div');
  body.className = 'body';
  body.textContent = data.text || '';

  li.appendChild(body);

  if(data.file){
    const fileBox = document.createElement('a');
    fileBox.href = data.file.url;
    fileBox.target = '_blank';
    fileBox.rel = 'noopener noreferrer';
    fileBox.className = 'file';
    fileBox.title = data.file.name;

    if(/^image\//.test(data.file.type)){
      const img = document.createElement('img');
      img.src = data.file.url;
      img.alt = data.file.name;
      fileBox.appendChild(img);
    }
    const label = document.createElement('div');
    label.textContent = data.file.name + ' (' + (data.file.type || 'file') + ')';
    fileBox.appendChild(label);
    li.appendChild(fileBox);
  }

  const meta = document.createElement('div');
  meta.className = 'meta';
  const who = document.createElement('span');
  who.className = 'name';
  who.textContent = data.name || 'guest';
  const when = document.createElement('span');
  when.textContent = data.at?.toDate ? data.at.toDate().toLocaleString() : '';
  meta.appendChild(who); meta.appendChild(when);
  li.appendChild(meta);

  messages.appendChild(li);
}

composer.addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = msgInput.value.trim();
  const f = fileInput.files[0] || null;
  if(!text && !f) return;

  let fileData = null;
  if(f){
    const path = `rooms/${currentRoom}/${Date.now()}-${f.name}`;
    const ref = sRef(storage, path);
    const uploadTask = uploadBytesResumable(ref, f);

    await new Promise((resolve, reject) => {
      uploadTask.on('state_changed', () => {}, reject, resolve);
    });
    const url = await getDownloadURL(uploadTask.snapshot.ref);
    fileData = { name: f.name, type: f.type, url };
    fileInput.value = '';
  }

  await addDoc(collection(db, 'rooms', currentRoom, 'messages'), {
    text: text || null,
    uid: auth.currentUser.uid,
    name: auth.currentUser.displayName || ('guest-' + auth.currentUser.uid.slice(0,6)),
    at: serverTimestamp(),
    file: fileData
  });

  msgInput.value = '';
});

// fun background sparks
const canvas = document.getElementById('sparkCanvas');
const ctx = canvas.getContext('2d');
let W, H; const P = [];
function resize(){ W = canvas.width = innerWidth; H = canvas.height = innerHeight }
addEventListener('resize', resize); resize();
for(let i=0;i<80;i++) P.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*.5,vy:(Math.random()-.5)*.5});
function tick(){
  ctx.clearRect(0,0,W,H);
  for(const p of P){
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0||p.x>W) p.vx*=-1; if(p.y<0||p.y>H) p.vy*=-1;
    ctx.beginPath(); ctx.arc(p.x,p.y,1.2,0,Math.PI*2); ctx.fill();
  }
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);

// randomize glyph positions
for(const li of document.querySelectorAll('.glyphs li')){
  li.style.setProperty('--x', Math.round(Math.random()*100)+'%');
  li.style.setProperty('--y', Math.round(Math.random()*100)+'%');
  li.style.animationDuration = (10 + Math.random()*12) + 's';
}
</script>

<!-- ============================= -->
<!-- 4) firebaseConfig.js          -->
<!-- ============================= -->
<script type="module" id="__fb_placeholder__">/* Move this content into firebaseConfig.js */
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
import { getStorage } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js';

// 1) Replace the below config with your Firebase project web app config
export const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// 2) Initialize Firebase singletons
export const app = initializeApp(firebaseConfig);
export const auth = getAuth(app);
export const db = getFirestore(app);
export const storage = getStorage(app);

/* Suggested Firebase Security Rules (set in Console):
Firestore rules (easy start):
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /rooms/{room} {
      allow read: if true; // demo
      allow write: if request.auth != null; // require signed-in (anonymous OK)
      match /messages/{id} { allow read, write: if true; }
      match /presence/{id} { allow read, write: if true; }
    }
  }
}

Storage rules:
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /rooms/{room}/{allPaths=**} {
      allow read; // public read
      allow write: if request.auth != null; // only signed-in can upload
    }
  }
}
*/
</script>
